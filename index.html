<html>

<head>
  <title>Face Detect Online</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"
    integrity="sha512-2RDFHqfLZW8IhPRvQYmK9bTLfj/hddxGXQAred2wNZGkrKQkLGj8RCkXfRJPHlDerdHHIzTFaahq4s/P4V6Qig=="
    crossorigin="anonymous"></script>
</head>

<body style="background-color: black;">
  <h1>Face Detect Online</h1>
  <video style="display: none;" id="video" width="500px" height="300px" autoplay="autoplay"></video>
  <img src="http://192.168.1.177:5000/video_feed" />
  <div click='stop' style="color: wheat;" id="stop">stop</div>
</body>

</html>
<script>
  var socket = io.connect("http://192.168.1.177:5000");

  var MediaUtils = {
    getUserMedia: function (videoEnable, audioEnable, callback) {
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || window.getUserMedia;
      var constraints = {
        video: videoEnable,
        audio: audioEnable
      };
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
          callback(false, stream);
        })['catch'](function (err) {
          callback(err);
        });
      } else if (navigator.getUserMedia) {
        navigator.getUserMedia(constraints, function (stream) {
          callback(false, stream);
        }, function (err) {
          callback(err);
        });
      } else {
        callback(new Error('Not support userMedia'));
      }
    },
  }
  
  function stop() {
    const video = document.querySelector('#video');
    // A video's MediaStream object is available through its srcObject attribute
    const mediaStream = video.srcObject;
    // Through the MediaStream, you can get the MediaStreamTracks with getTracks():
    const tracks = mediaStream.getTracks();
    // Or stop all like so:
    tracks.forEach(track => track.stop())
  }

  function requestMedia() {
    var chunks = []
    MediaUtils.getUserMedia(true, true, (err, stream) => {
      if (err) throw err
      var elementVideo = document.querySelector("#video");
      elementVideo.srcObject = stream;
      var canvas = document.createElement("canvas");
      setInterval(() => {
        canvas.getContext('2d').drawImage(elementVideo, 0, 0, elementVideo.width, elementVideo.height);
        socket.emit('stream', canvas.toDataURL("image/jpeg"));
      }, 250);
    })
  }
  requestMedia()
</script>